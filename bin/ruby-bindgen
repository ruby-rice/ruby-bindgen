#! /usr/bin/env ruby

# To make testing/debugging easier test within this source tree versus an installed gem
require 'bundler/setup'

require 'ruby-bindgen/config'

module RubyBindGen
  class Cmd
    attr_reader :config

    def initialize
      parse_args
      @config = RubyBindgen::Config.new(@config_path)
      setup_libclang unless @config[:format] == 'CMake'
      require 'ruby-bindgen'
      validate_config
    end

    def parse_args
      if ARGV.empty? || ARGV[0] == '-h' || ARGV[0] == '--help'
        puts usage
        exit(ARGV.empty? ? 1 : 0)
      end

      @config_path = ARGV[0]

      unless File.exist?(@config_path)
        raise "Config file not found: #{@config_path}"
      end
    end

    def usage
      <<~USAGE
        ruby-bindgen

        Usage: ruby-bindgen <config.yaml>

        Generates Ruby bindings for C and C++ libraries using a YAML configuration file.

        See documentation for config file format: https://github.com/ruby-rice/ruby-bindgen/blob/main/docs/configuration.md

        Options:
          -h, --help    Show this help message
      USAGE
    end

    def setup_libclang
      if @config[:libclang]
        ENV['LIBCLANG'] = @config[:libclang]
      end
    end

    def validate_config
      raise "Config must specify 'output'" unless @config[:output]
      raise "Config must specify 'format'" unless @config[:format]

      unless %w[FFI Rice CMake].include?(@config[:format])
        raise "Format must be 'FFI', 'Rice', or 'CMake', got: #{@config[:format]}"
      end

      # Input defaults to output for CMake (scans generated files in output dir)
      @config[:input] ||= @config[:output]

      unless File.directory?(@config[:input])
        raise "Input path must be a directory: #{@config[:input]}"
      end

      unless File.directory?(@config[:output])
        raise "Output path must be a directory: #{@config[:output]}"
      end

      # Validate project name is a valid C/C++ identifier (if provided)
      if @config[:project] && !@config[:project].match?(/\A[A-Za-z_][A-Za-z0-9_]*\z/)
        raise "Project name must be a valid C/C++ identifier: #{@config[:project]}"
      end
    end

    def run
      input = @config[:input]
      default_match = input == @config[:output] ? ["**/*-rb.cpp"] : ["**/*.{h,hpp}"]
      match_patterns = @config[:match] || default_match
      skip_patterns = @config[:skip] || []

      inputter = RubyBindgen::Inputter.new(input, match_patterns, skip_patterns)
      outputter = RubyBindgen::Outputter.new(@config[:output])

      generator_klass = RubyBindgen::Generators.const_get(@config[:format])
      generator = generator_klass.new(inputter, outputter, @config)
      generator.generate
    end
  end
end

begin
  cmd = RubyBindGen::Cmd.new
  cmd.run
rescue => e
  STDERR.puts "Error: #{e.message}"
  exit 1
end
