cmake_minimum_required(VERSION 3.26)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

project("<%= project %>" LANGUAGES CXX)

# Create the Extension Library
if (MSVC)
  add_library(${CMAKE_PROJECT_NAME} SHARED)
else ()
  add_library(${CMAKE_PROJECT_NAME} MODULE)
endif ()

# Fetch Rice from GitHub
include(FetchContent)

FetchContent_Declare(
  rice
  GIT_REPOSITORY https://github.com/ruby-rice/rice.git
  GIT_TAG master
)
FetchContent_MakeAvailable(rice)

# Configure Ruby Detection
list(PREPEND CMAKE_MODULE_PATH "${rice_SOURCE_DIR}")

# Find Ruby
find_package(Ruby REQUIRED)

target_link_libraries(${CMAKE_PROJECT_NAME} PRIVATE
  Ruby::Module
)

# Link to Rice
target_link_libraries(${CMAKE_PROJECT_NAME} PRIVATE
  Rice::Rice
)

# Include Directories
<% include_dirs.each do |dir| -%>
target_include_directories(${CMAKE_PROJECT_NAME} PRIVATE
  "<%= dir %>"
)
<% end -%>

# Configure Extension Output
get_target_property(RUBY_EXT_SUFFIX Ruby::Ruby INTERFACE_RUBY_EXTENSION_SUFFIX)

set_target_properties(${CMAKE_PROJECT_NAME} PROPERTIES
  PREFIX ""
  SUFFIX "${RUBY_EXT_SUFFIX}"
  OUTPUT_NAME "<%= project %>"
  CXX_VISIBILITY_PRESET hidden
  VISIBILITY_INLINES_HIDDEN ON
  WINDOWS_EXPORT_ALL_SYMBOLS OFF
  RUNTIME_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/../lib/${Ruby_VERSION_MAJOR}.${Ruby_VERSION_MINOR}"
  LIBRARY_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/../lib"
)

# Subdirectories
<% directories.each do |directory| -%>
add_subdirectory("<%= directory.relative_path_from(directory.parent) %>")
<% end -%>

# Sources
<% if !files.empty? -%>
target_sources(${CMAKE_PROJECT_NAME} PRIVATE
<% files.each do |file| -%>
  "<%= file.relative_path_from(file.parent) %>"
<% end -%>
)
<% end -%>
