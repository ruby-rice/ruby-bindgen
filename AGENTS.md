# Agent Instructions

## About ruby-bindgen
For ruby-bindgen features and capabilities, see [docs/features.md](docs/features.md).
For configuration options, see [docs/configuration.md](docs/configuration.md).

## Key Files

- `lib/ruby-bindgen/visitors/rice/rice.rb` - Main visitor that walks the AST
- `lib/ruby-bindgen/visitors/rice/*.erb` - ERB templates that generate Rice C++ code
- `test/headers/cpp/*.hpp` - Test input headers
- `test/bindings/cpp/*-rb.cpp` - Expected output (golden files)

## Running Tests

```bash
# Run all tests
bundle exec ruby -Ilib -Itest test/rice_test.rb
bundle exec ruby -Ilib -Itest test/cmake_test.rb

# Run a specific test
bundle exec ruby -Ilib -Itest test/rice_test.rb --name test_classes

# Regenerate expected files after making changes
UPDATE_EXPECTED=1 bundle exec ruby -Ilib -Itest test/rice_test.rb
UPDATE_EXPECTED=1 bundle exec ruby -Ilib -Itest test/cmake_test.rb
```

**NOTE:** cmake_test must run after rice_test because it scans for `*-rb.cpp` files generated by rice_test.

All 16 Rice tests: classes, enums, functions, inheritance, template, constructors, operators, default_values, iterators, template_inheritance, overloads, incomplete_types, filtering, template_defaults, buffers, cross_file_typedef

**IMPORTANT:** Before using `UPDATE_EXPECTED=1` or committing any changes, you MUST first run ALL tests to verify your changes don't break existing functionality. Never blindly update expected files without checking for regressions.

## Test Coverage Requirements

**Every bug fix MUST include test coverage.** Add test cases to the appropriate header file in `test/headers/cpp/` and update the expected output in `test/bindings/cpp/`.

For typedef-related issues, use `cross_file_base.hpp` and `cross_file_derived.hpp`.

## Regenerate opencv-ruby bindings

See `/mnt/c/Source/opencv-ruby/ext/bindings.yaml` for the full configuration. Use the match field to configure what *.h/*.hpp files are processed and thus generate bindings for.   

```bash
# Generate bindings
cd /mnt/c/Source/ruby-bindgen
bundle exec ruby -Ilib bin/ruby-bindgen /mnt/c/Source/opencv-ruby/ext/bindings.yaml
```
