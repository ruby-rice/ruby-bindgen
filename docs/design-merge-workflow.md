# Design: Generated Code Merge Workflow

## Keeping Bindings Up to Date

When wrapping C++ libraries with ruby-bindgen, you often need to make manual modifications to generated files:

```cpp
// Generated by ruby-bindgen
Rice::Data_Type<cv::Mat> rb_cCvMat = define_class_under<cv::Mat>(rb_mCv, "Mat").
  define_constructor(Constructor<cv::Mat>()).
  define_method("rows", &cv::Mat::rows).
  define_method("cols", &cv::Mat::cols);

// MANUAL: Added custom to_s for debugging
// MANUAL: Added inspect for REPL
// MANUAL: Added each/each_with_index for iteration
// MANUAL: Added template method workarounds for at<T>()
// MANUAL: Added version guards for OpenCV 4.x vs 3.x
```

When regenerating bindings (upstream library update, ruby-bindgen bugfix, new features), you must:

1. Regenerate all files (overwrites manual changes)
2. Manually identify what was lost (diff against old version)
3. Manually re-apply every custom change
4. Test everything works together
5. Repeat for every file with manual changes

**Real cost**: opencv-ruby has ~350 generated files (175 .cpp + 175 .hpp), with manual changes in a subset. Last full regeneration took 2 days of engineer time.

### Types of Manual Changes

| Type | Example | Frequency |
|------|---------|-----------|
| Includes | `#include <sstream>` for `to_s` | Common |
| Version guards | `#if CV_VERSION_MAJOR >= 4` | Common |
| Custom methods | `to_s`, `inspect`, `each`, `[]` | Common |
| Method fixes | Signature corrections, casts | Occasional |
| Template workarounds | Manual instantiation of `Mat::at<T>` | Rare but extensive |
| Entire file replacement | File too complex to generate | Rare |

## Solution: Git Branch Merge Workflow

### Core Concept

```
main branch:        [generated code] + [manual changes]
                           │
                           │ manual changes live here as commits
                           │
generated branch:   [generated code only]
                           │
                           │ pure ruby-bindgen output
                           │
                           ▼
                    On regeneration, merge generated → main
                    Git preserves manual changes via 3-way merge
                    Rerere remembers conflict resolutions
```

### Why This Works

Git's 3-way merge compares:
- **Base**: Last common ancestor (previous generated version)
- **Ours**: main branch (generated + manual changes)
- **Theirs**: generated branch (new generated version)

```
Example: mat-rb.cpp

Base (last generated):        Theirs (new generated):      Ours (main):
─────────────────────        ─────────────────────        ─────────────────────
define_method("rows"...)     define_method("rows"...)     define_method("rows"...)
define_method("cols"...)     define_method("cols"...)     define_method("cols"...)
                             define_method("depth"...)    define_method("to_s"...)  ← MANUAL
                             ↑ NEW from generator         define_method("cols"...)

Merge result:
─────────────────────
define_method("rows"...)
define_method("cols"...)
define_method("depth"...)    ← Merged in from generator
define_method("to_s"...)     ← Preserved manual change
```

### When Conflicts Occur

Conflicts happen when both branches modify the same lines:

```cpp
// Base (last generated):
define_method("continuous?", &cv::Mat::isContinuous);

// Theirs (new generated) - ruby-bindgen changed naming:
define_method("continuous?", &cv::Mat::isContinuous,
  Arg("i") = static_cast<int>(-1));

// Ours (main) - you added custom wrapper:
define_method("continuous?", [](const cv::Mat& self) {
  return self.isContinuous();
});

// CONFLICT - both modified the same method
```

Git marks this as a conflict. You resolve it once. **Rerere remembers the resolution forever.**

---

## Detailed Workflow

### Phase 1: Initial Setup (One-Time)

#### Step 1.1: Enable Rerere

```bash
cd /path/to/opencv-ruby

# Enable rerere for this repository
git config rerere.enabled true

# Optional: Share rerere cache across machines
git config rerere.autoupdate true
```

**What this does**: Creates `.git/rr-cache/` directory. Git stores conflict fingerprints and their resolutions here.

#### Step 1.2: Prepare Main Branch

Ensure main branch is clean and all manual changes are committed:

```bash
git checkout main
git status  # Should be clean

# Tag current state for reference
git tag pre-merge-workflow
```

#### Step 1.3: Create Generated Branch

```bash
# Create branch from main
git checkout -b generated

# Now we need to create a "pure generated" baseline
# Option A: Regenerate everything from scratch
# Option B: Revert manual changes file-by-file

# We'll use Option A - cleaner baseline
```

#### Step 1.4: Create Pure Generated Baseline

```bash
# On generated branch, regenerate all bindings
# This overwrites everything - manual changes are lost (but preserved on main)
cd /path/to/ruby-bindgen
bundle exec ruby -Ilib bin/ruby-bindgen /path/to/opencv-ruby/ext/bindings.yaml

# Back in opencv-ruby
cd /path/to/opencv-ruby

# See what changed
git status
git diff --stat

# Commit the pure generated output
git add ext/
git commit -m "Pure generated baseline - no manual changes"
```

**Important**: This commit represents "what ruby-bindgen outputs with zero manual modifications."

#### Step 1.5: First Merge (Establishes Manual Changes)

```bash
# Switch back to main
git checkout main

# Merge generated branch
# This will show conflicts where manual changes exist
git merge generated

# Example output:
# Auto-merging ext/opencv2/core/mat-rb.cpp
# CONFLICT (content): Merge conflict in ext/opencv2/core/mat-rb.cpp
# Auto-merging ext/opencv2/imgproc/imgproc-rb.cpp
# CONFLICT (content): Merge conflict in ext/opencv2/imgproc/imgproc-rb.cpp
# Automatic merge failed; fix conflicts and then commit the result.
```

#### Step 1.6: Resolve Initial Conflicts

For each conflicted file:

```bash
# See conflicts
git diff --name-only --diff-filter=U

# Open each file and resolve
# The pattern is: KEEP the main (ours) version for manual changes
```

Example conflict in `mat-rb.cpp`:

```cpp
<<<<<<< HEAD
// Manual includes for custom methods
#include <sstream>
#include <iomanip>

#include <mat.hpp>
||||||| merged common ancestors
#include <mat.hpp>
=======
#include <mat.hpp>
>>>>>>> generated
```

Resolution: Keep the HEAD (main) version with manual includes:

```cpp
// Manual includes for custom methods
#include <sstream>
#include <iomanip>

#include <mat.hpp>
```

#### Step 1.7: Complete Initial Merge

```bash
# After resolving all conflicts
git add ext/
git commit -m "Merge generated branch - preserve manual changes"

# Rerere has now recorded all resolutions
ls .git/rr-cache/
# Shows hash directories for each recorded resolution
```

---

### Phase 2: Regeneration Workflow (Repeatable)

When you need to regenerate (upstream update, ruby-bindgen fix, etc.):

#### Step 2.1: Update Generated Branch

```bash
# Switch to generated branch
git checkout generated

# Regenerate all bindings
cd /path/to/ruby-bindgen
bundle exec ruby -Ilib bin/ruby-bindgen /path/to/opencv-ruby/ext/bindings.yaml

# Back in opencv-ruby
cd /path/to/opencv-ruby

# Review changes
git status
git diff --stat

# Commit new generated output
git add ext/
git commit -m "Regenerate bindings - opencv 4.9.0 / ruby-bindgen abc123"
```

#### Step 2.2: Merge to Main

```bash
git checkout main
git merge generated

# Possible outcomes:
# 1. Clean merge - no conflicts, all manual changes preserved
# 2. Auto-resolved - rerere applied remembered resolutions
# 3. New conflicts - genuinely new conflicts needing resolution
```

#### Step 2.3: Handle Rerere Auto-Resolution

When rerere auto-resolves:

```bash
$ git merge generated
Auto-merging ext/opencv2/core/mat-rb.cpp
Recorded preimage for 'ext/opencv2/core/mat-rb.cpp'
CONFLICT (content): Merge conflict in ext/opencv2/core/mat-rb.cpp
Resolved 'ext/opencv2/core/mat-rb.cpp' using previous resolution.
Automatic merge failed; fix conflicts and then commit the result.

# Rerere resolved it! Verify and commit:
git diff ext/opencv2/core/mat-rb.cpp  # Review the resolution
git add ext/opencv2/core/mat-rb.cpp
git commit -m "Merge regenerated bindings"
```

#### Step 2.4: Handle New Conflicts

New conflicts occur when:
- Generator changed a line you also manually modified
- Generator removed code you modified
- Generator restructured file significantly

```bash
# See what needs manual resolution
git diff --name-only --diff-filter=U

# Resolve each file
# Then commit - rerere learns the new resolution
git add ext/
git commit -m "Merge regenerated bindings - resolve new conflicts"
```

---

## File-Level Details

### Directory Structure

```
opencv-ruby/
├── ext/
│   ├── bindings.yaml           # ruby-bindgen configuration
│   ├── opencv2/
│   │   ├── core/
│   │   │   ├── mat-rb.cpp      # Generated + heavy manual changes
│   │   │   ├── mat-rb.hpp      # Generated
│   │   │   └── ...
│   │   ├── imgproc/
│   │   │   ├── imgproc-rb.cpp  # Generated + some manual changes
│   │   │   └── ...
│   │   └── ...
│   └── rice_include.hpp        # Generated
├── .git/
│   └── rr-cache/               # Rerere resolution cache
│       ├── a1b2c3d.../         # Resolution for conflict fingerprint
│       │   ├── preimage        # What the conflict looked like
│       │   └── postimage       # How it was resolved
│       └── ...
└── .gitattributes              # Optional merge driver config
```

### Identifying Manual Changes

After setup, you can always see what's manual:

```bash
# Full diff of all manual changes
git diff generated..main -- ext/

# List files with manual changes
git diff --name-only generated..main -- ext/

# Stats on manual changes per file
git diff --stat generated..main -- ext/
```

Example output:

```
ext/opencv2/core/mat-rb.cpp      | 247 +++++++++++++++++++++++-
ext/opencv2/imgproc/imgproc-rb.cpp |  23 ++-
ext/opencv2/highgui/highgui-rb.cpp |  15 ++
3 files changed, 285 insertions(+)
```

### Tracking Manual Change Categories

Consider using structured comments to categorize manual changes:

```cpp
// MANUAL:INCLUDE - Custom includes
#include <sstream>

// MANUAL:VERSION - Version-specific code
#if CV_VERSION_MAJOR >= 4
  // OpenCV 4.x specific
#endif

// MANUAL:METHOD - Custom Ruby methods
define_method("to_s", [](const cv::Mat& self) {
  std::ostringstream oss;
  oss << "Mat(" << self.rows << "x" << self.cols << ")";
  return oss.str();
});

// MANUAL:WORKAROUND - Template method workarounds
// cv::Mat::at<T> can't be bound directly, need explicit instantiation
define_method("at_uchar", &mat_at<uchar>);
define_method("at_float", &mat_at<float>);
```

This makes manual changes searchable and documentable:

```bash
# Find all manual changes by category
grep -r "MANUAL:METHOD" ext/
grep -r "MANUAL:WORKAROUND" ext/
```

---

## Edge Cases and Troubleshooting

### Case 1: File Completely Removed by Generator

Generator stops generating a file you have manual changes in.

```bash
$ git merge generated
CONFLICT (modify/delete): ext/opencv2/legacy/legacy-rb.cpp deleted in generated
and modified in HEAD. Version HEAD of ext/opencv2/legacy/legacy-rb.cpp left in tree.
```

**Resolution options**:
- Keep the file (if still needed): `git add ext/opencv2/legacy/legacy-rb.cpp`
- Delete it (no longer needed): `git rm ext/opencv2/legacy/legacy-rb.cpp`

### Case 2: File Renamed by Generator

```bash
$ git merge generated
CONFLICT (rename/rename): ext/opencv2/cv-rb.cpp renamed to ext/opencv2/core-rb.cpp
in generated and to ext/opencv2/cv-rb.cpp in HEAD.
```

**Resolution**: Usually accept the generator's rename and re-apply manual changes to new location.

### Case 3: Rerere Gives Wrong Resolution

Sometimes a remembered resolution becomes incorrect (e.g., manual change is no longer needed).

```bash
# Forget a specific resolution
git rerere forget ext/opencv2/core/mat-rb.cpp

# Re-resolve during next merge
git checkout --conflict=merge ext/opencv2/core/mat-rb.cpp
# Edit file
git add ext/opencv2/core/mat-rb.cpp
```

### Case 4: Massive Restructuring by Generator

If ruby-bindgen significantly changes output format, many conflicts occur.

**Strategy**:
1. Consider if manual changes are still needed
2. Resolve file-by-file, letting rerere learn
3. For very different structure, may be easier to:
   - Accept generated version
   - Re-apply manual changes from `git show main:ext/path/file.cpp`

### Case 5: Partial Regeneration (Single File)

Sometimes you only want to regenerate one file:

```bash
# On generated branch
git checkout generated

# Regenerate just mat.hpp bindings
bundle exec ruby -Ilib bin/ruby-bindgen bindings.yaml --only mat.hpp

# Commit
git add ext/opencv2/core/mat-rb.cpp ext/opencv2/core/mat-rb.hpp
git commit -m "Regenerate mat bindings only"

# Merge to main
git checkout main
git merge generated
```

---

## CLI Tool Design

### Command: `ruby-bindgen merge init`

```bash
$ ruby-bindgen merge init

Initializing merge workflow...

[1/5] Checking git repository... OK
[2/5] Enabling rerere... OK
      Created .git/rr-cache/
[3/5] Creating 'generated' branch... OK
[4/5] Regenerating baseline (overwrites manual changes on this branch)...
      Processing: opencv2/core/mat.hpp
      Processing: opencv2/imgproc/imgproc.hpp
      ... (175 files)
      Writing: ext/opencv2/core/mat-rb.cpp
      ... (175 files)
[5/5] Committing baseline... OK
      Committed: "Pure generated baseline - ruby-bindgen v1.2.3"

Next steps:
  1. Switch to main branch: git checkout main
  2. Merge generated branch: git merge generated
  3. Resolve conflicts (these are your manual changes)
  4. Commit: git commit -m "Initial merge - preserve manual changes"

Your manual changes will be preserved in all future regenerations.
```

### Command: `ruby-bindgen merge regenerate`

```bash
$ ruby-bindgen merge regenerate

Regenerating bindings and merging...

[1/6] Switching to 'generated' branch... OK
[2/6] Regenerating bindings...
      Processing: 175 headers
      Writing: 350 files (175 .cpp + 175 .hpp)
[3/6] Committing... OK
      Committed: "Regenerate bindings - 2024-01-15"
[4/6] Switching to 'main' branch... OK
[5/6] Merging 'generated' branch...
      Auto-merged: 45 files
      Rerere resolved: 3 files
      Conflicts: 2 files
[6/6] Summary:

      Files merged cleanly:     45
      Rerere auto-resolved:      3
      New conflicts to resolve:  2
        - ext/opencv2/core/mat-rb.cpp
        - ext/opencv2/dnn/dnn-rb.cpp

To complete the merge:
  1. Resolve conflicts in the files listed above
  2. git add <resolved files>
  3. git commit

Tip: Use 'git diff --name-only --diff-filter=U' to see conflicted files
```

### Command: `ruby-bindgen merge diff`

```bash
$ ruby-bindgen merge diff

Manual changes (diff between 'generated' and 'main'):

ext/opencv2/core/mat-rb.cpp (+247 lines)
  MANUAL:INCLUDE    3 additions
  MANUAL:VERSION    12 additions (2 blocks)
  MANUAL:METHOD     45 additions (5 methods: to_s, inspect, each, [], []=)
  MANUAL:WORKAROUND 187 additions (template method instantiations)

ext/opencv2/imgproc/imgproc-rb.cpp (+23 lines)
  MANUAL:METHOD     23 additions (2 methods: to_s, inspect)

ext/opencv2/highgui/highgui-rb.cpp (+15 lines)
  MANUAL:VERSION    15 additions (1 block)

Total: 3 files, 285 manual additions

Use 'ruby-bindgen merge diff --full' for complete diff output
Use 'ruby-bindgen merge diff --file mat-rb.cpp' for single file
```

### Command: `ruby-bindgen merge status`

```bash
$ ruby-bindgen merge status

Merge workflow status:

  Rerere enabled:     Yes
  Generated branch:   generated (abc1234)
  Main branch:        main (def5678)

  Last regeneration:  2024-01-10 (5 days ago)
  Manual changes:     3 files, 285 additions
  Rerere resolutions: 12 recorded

  Branch divergence:
    main is 3 commits ahead of generated
    generated is 0 commits ahead of main

  Recommendation: Branches are in sync. Regenerate when needed.
```

### Command: `ruby-bindgen merge export`

Export manual changes as patches (backup/documentation):

```bash
$ ruby-bindgen merge export

Exporting manual changes to patches/...

  patches/mat-rb.cpp.patch (247 lines)
  patches/imgproc-rb.cpp.patch (23 lines)
  patches/highgui-rb.cpp.patch (15 lines)

Exported 3 patch files.

To apply manually: git apply patches/*.patch
```

---

## Configuration

### bindings.yaml additions

```yaml
# Existing ruby-bindgen config...
headers:
  - opencv2/core/mat.hpp
  - opencv2/imgproc/imgproc.hpp

output_dir: ext/

# NEW: Merge workflow configuration
merge:
  # Enable merge workflow features
  enabled: true

  # Branch names (defaults shown)
  generated_branch: generated
  main_branch: main

  # Files that are entirely manual (never generated)
  # These are excluded from the generated branch
  manual_only:
    - ext/opencv2/custom_helpers.cpp
    - ext/opencv2/custom_helpers.hpp
    - ext/ruby_opencv.cpp  # Main entry point, manually maintained

  # Files to skip during regeneration (keep existing)
  # Use when a file needs heavy manual work and regeneration would lose too much
  skip_regenerate:
    - ext/opencv2/core/mat-rb.cpp  # Too many manual changes, maintain manually

  # Notification settings
  notify:
    # Warn if manual changes exceed threshold
    max_manual_lines: 500
    # Warn if file hasn't been regenerated in N days
    stale_days: 30
```

### .gitattributes for merge behavior

Optional: Configure merge behavior per file type:

```gitattributes
# Use union merge for generated files (combine both sides)
# This can reduce conflicts for additive changes
ext/**/*-rb.cpp merge=union

# Or use custom merge driver
ext/**/*-rb.cpp merge=ruby-bindgen
```

Custom merge driver (in .git/config):

```ini
[merge "ruby-bindgen"]
    name = Ruby-bindgen aware merge
    driver = ruby-bindgen merge-driver %O %A %B %P
```

---

## Future Enhancements

### Smart Section Preservation

Detect and preserve marked sections without conflicts:

```cpp
// BEGIN MANUAL: custom_methods
define_method("to_s", ...);
define_method("inspect", ...);
// END MANUAL: custom_methods
```

Generator would:
1. Parse existing file for MANUAL sections
2. Generate new content
3. Re-insert MANUAL sections at appropriate locations
4. No git conflict needed

### Automatic Conflict Resolution Hints

When a conflict occurs, provide context:

```
CONFLICT in ext/opencv2/core/mat-rb.cpp

  Context: Method 'isContinuous' signature changed

  Generated (new):
    define_method("continuous?", &cv::Mat::isContinuous,
      Arg("i") = static_cast<int>(-1));

  Your version (manual):
    define_method("continuous?", [](const cv::Mat& self) {
      return self.isContinuous();
    });

  Suggestion: Your lambda wrapper may no longer be needed.
              The generator now handles this case correctly.
              Consider accepting the generated version.
```

### Deprecation Warnings

Track when manual changes become unnecessary:

```
WARNING: Manual change may be obsolete

  File: ext/opencv2/core/mat-rb.cpp
  Change: Lambda wrapper for isContinuous
  Added: 2023-06-15 (commit abc123)
  Reason: "Generator didn't handle default params"

  This was fixed in ruby-bindgen v1.2.0 (2024-01-01).
  Consider removing the manual change.
```

